

<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>JavaScript Reference Tracer</title>

<link rel=stylesheet href="../../interp/tracer/codemirror/lib/codemirror.css">
<script src="../../interp/tracer/codemirror/lib/codemirror.js"></script>
<script src="../../interp/tracer/jquery-2.1.1.min.js"></script>
<script src="sparray.js"></script>
<script type = "text/javascript" src="demo_trace.js"></script>

<style>
.source_div {
   border-top: 1px solid black; 
   border-bottom: 1px solid black;
}

#file_list {
   height: 1em;
   margin-top: 8px;
   margin-bottom: 8px;
}

.file_item, .file_item_current {
   margin-right: 5px;
   padding: 5px;
   text-decoration: underline;
}

.file_item, .file_item_current:hover {
   cursor: pointer; 
   cursor: hand;
}

.file_item {
   background-color: #FAFAFA;
}

.file_item_current {
   background-color: #FFCCCC;
}

#main_table td {
   vertical-align: top;
   border: 1px solid black;
}

.CodeMirror-selected { background: #F3F781; }
.CodeMirror-focused .CodeMirror-selected { background: #F3F781; }

</style>


</head>
<body>

<h2>Mini-ML Interpreter</h2>

<div><textarea id='source_code' style="width: 50em; height: 3em">
javascript source code here
</textarea>
<input type="button" id="button_run" value="RUN" />
<span id="run_output"></span>
</div>

<br/>
<div>
Navigation:
<input type="textbox" id='navigation_step' style="width:3em" value="0"/>
<input type="button" id='button_reset' value="Reset" />
<input type="button" id='button_prev' value="Prev" />
<input type="button" id='button_next' value="Next" />
Reach condition:
<input type="textbox" id='button_condition' style="width:30em" />
<input type="button" id='button_reach' value="Reach" />
<span id="reach_output"></span>
</div>

<br/>

<div style="font-size:0.8em">Instructions: from console, the variable "h" denotes the current heap.</div>

<div style="font-size:0.8em">Instructions: type 'S' for step (next function call), 'N' for next (next call at same level), 'B' for backstep (symmetric to step), 'P' for previous (symmetric to next), 'F' for finish (next call at upper level), 'R' for restart.</div>

<div id='file_list'></div>

<div class='source_div'>
<table id='main_table'>
<tr>
<td><textarea id='interpreter_code' class='source' rows='20' cols='60'></textarea></td>
<td width='600'><div id='infos'>infos here</div>
</td>
</div>

<script type = "text/javascript">

   var tracer_length = tracer_items.length;
   var tracer_pos = 0; 

   function stepTo(step) {
      tracer_pos = step;
      updateSelection();
   }

   $("#button_run").click(function() {
     $("#run_output").html("Run successful !");
     var timeoutID = window.setTimeout(function() { $("#run_output").html(""); }, 1000);
   });

   $("#button_reset").click(function() {
     stepTo(0);
   });

   $("#button_prev").click(function() {
     stepTo(Math.max(0, tracer_pos-1));
   });

   $("#button_next").click(function() {
     stepTo(Math.min(tracer_length-1, tracer_pos+1));
   });

   $("#button_reach").click(function() {
     $("#reach_output").html("Not found");
     var timeoutID = window.setTimeout(function() { $("#reach_output").html(""); }, 1000);
   });

   // Assumes tracer_files to be an array of objects with two field:
   // - file, containing the name of the file,
   // - contents, a string containing its source code

   // Assumes tracer_items to be an array with items, e.g.:
   // { type: 'enter', file: 'foo.ml', start_line: 4, start_col: 0, end_line: 5, end_col: 10 },
   // { type: 'exit', file: 'foo.ml', start_line: 4, start_col: 0, end_line: 5, end_col: 10 },
   // { type: 'other_event', file: 'foo.ml', start_line: 4, start_col: 0, end_line: 5, end_col: 10 },

   function tracer_valid_pos(i) {
      return (i >= 0 && i < tracer_length);
   }

   // dir is -1 or +1
   function shared_step(dir) { 
      var i = tracer_pos;
      i += dir; 
      if (! tracer_valid_pos(i)) 
         return; // not found, we donâ€™t update the tracer position.
      tracer_pos = i;
   }

   // dir is -1 or +1,
   // target (= target depth) is 0 for (next/prev) or -1 (finish)
   function shared_next(dir, target) { 
      var i = tracer_pos;
      var depth = 0;
      var ty = tracer_items[i].type;
      if (dir === +1 && ty === 'exit') {
         depth = 1;
      } else if (dir === -1 && ty === 'enter') {
         depth = -1;
      } 
      while (true) {
         if (! tracer_valid_pos(i)) {
            tracer_pos = i - dir; // just before out of range
            return; // not found
         }
         if (i !== tracer_pos && depth === target) {
            tracer_pos = i;
            return;
         }
         var ty = tracer_items[i].type;
         if (ty === 'enter') {
            depth++;
         } else if (ty === 'exit') {
            depth--;
         }
         i += dir; 
      }
   }

   function restart() { tracer_pos = 0; }
   function step() { shared_step(+1); }
   function backstep() { shared_step(-1); }
   function next() { shared_next(+1, 0); }
   function previous() { shared_next(-1, 0); }
   function finish() { shared_next(+1, -1); } 

   var curfile = '';

   var docs = {};
   for (var i = 0; i < tracer_files.length; i++) {
      var file = tracer_files[i].file;
      var txt = tracer_files[i].contents;
      docs[file] = CodeMirror.Doc(txt, 'js');
   }

   var editor = null;

   function viewFile(file) {
      if (curfile !== file) {
         curfile = file;
         editor.swapDoc(docs[curfile]);
         editor.focus();
         updateFileList();
      }
   }

   function updateFileList() {
      var s = '';
      for (var i = 0; i < tracer_files.length; i++) {
         var file = tracer_files[i].file;
         s += "<span class=\"file_item" + ((curfile == file) ? '_current' : '') + "\" onclick=\"viewFile('" + file + "')\">" + file + "</span> ";
      }
      $('#file_list').html(s);
   }

   function updateSelection() {
      var item = tracer_items[tracer_pos];
      viewFile(item.file);
      var anchor = {line: item.start_line-1, ch: item.start_col};
      var head = {line: item.end_line-1, ch: item.end_col};

      console.log("pos: " + tracer_pos);
      var ty = tracer_items[tracer_pos].type;
      var color = (ty === 'enter') ? '#F3F781' : '#CCCCCC';
      //console.log("color " + color);
      $('.CodeMirror-selected').css({ background: color });
      $('.CodeMirror-focused .CodeMirror-selected').css({ background: color });
      $("#infos").html("type = " + ty);
      $("#navigation_step").val(tracer_pos);
      editor.setSelection(anchor, head);
      updateFileList();
   }

   editor = CodeMirror.fromTextArea(document.getElementById('interpreter_code'), {
      mode: 'js',
      lineNumbers: true,
      lineWrapping: true,
      readOnly: true,
      extraKeys: {
         'R': function(cm) { restart(); updateSelection(); },
         'S': function(cm) { step(); updateSelection(); },
         'B': function(cm) { backstep(); updateSelection(); },
         'N': function(cm) { next(); updateSelection(); },
         'P': function(cm) { previous(); updateSelection(); },
         'F': function(cm) { finish(); updateSelection(); },
      },
   });
   editor.setSize(400,300);

   editor.on('dblclick', function() {
      var line = editor.getCursor().line;
      var txt = editor.getLine(line);
      var prefix = "#sec-";
      var pos_start = txt.indexOf(prefix);
      if (pos_start === -1)
         return;
      var pos_end = txt.indexOf("*", pos_start);
      if (pos_end === -1)
         return;
      var sec = txt.substring(pos_start, pos_end);
      var url = "http://www.ecma-international.org/ecma-262/5.1/" + sec;
      window.open(url, '_blank');
   });

   editor.focus();
   updateSelection(editor);
</script>

</body>
</html>



<!---
$timeout(function() {codeMirror.refresh();});

this.codeMirrorInstance.setValue(content);
var that = this;
setTimeout(function() {
    that.codeMirrorInstance.refresh();
},1);

http://codemirror.net/demo/buffers.html

//CodeMirror.Doc(text
---->



